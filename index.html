<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webkonferencia</title>
    <link rel="stylesheet" href="styles.css">
    <!-- FontAwesome pre ikony -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha384-K6RqeWeci5ZR/Lv4MR0sA0F5YE6ls0sYDo0CZ76RUSjgI8V1xPY6z/6E4Xc1QyVZ" crossorigin="anonymous">
</head>
<body>
    <div class="container">
        <h1 class="title">Webkonferencia</h1>

        <!-- Lokálny video výstup -->
        <div class="webcam-frame">
            <video id="webcam" autoplay playsinline muted></video>
            <div id="webcam-text" class="webcam-text">Tu bude výstup z vašej kamery</div>
        </div>

        <!-- Vzdialený video výstup -->
        <div class="webcam-frame">
            <video id="remote-webcam" autoplay playsinline></video>
            <div id="remote-webcam-text" class="webcam-text">Čaká sa na druhého používateľa...</div>
        </div>

        <!-- Ovládacie tlačidlá -->
        <div class="controls">
            <button class="control-button active" id="mute-btn">
                <i id="mute-icon" class="fas fa-microphone"></i>
            </button>
            <button class="control-button active" id="camera-btn">
                <i id="camera-icon" class="fas fa-video"></i>
            </button>
            <button class="control-button red-background" id="hangup-btn">
                <i class="fas fa-phone-slash white-icon"></i>
            </button>
        </div>
    </div>

    <!-- Skripty -->
    <!-- Socket.io klientská knižnica -->
    <script src="/socket.io/socket.io.js"></script>
    <!-- Klientsky JavaScript kód -->
    <script>
        // Inicializácia premenných a prvkov
        const socket = io(); // Inicializácia socket.io
        const muteBtn = document.getElementById('mute-btn');
        const muteIcon = document.getElementById('mute-icon');
        const cameraBtn = document.getElementById('camera-btn');
        const cameraIcon = document.getElementById('camera-icon');
        const hangupBtn = document.getElementById('hangup-btn');
        const localVideo = document.getElementById('webcam');
        const remoteVideo = document.getElementById('remote-webcam');
        let localStream;
        let peerConnection;

        const config = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] // STUN server
        };

        // Získanie prístupu ku kamere a mikrofónu
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then((stream) => {
                localStream = stream;
                localVideo.srcObject = stream;

                if (!peerConnection) createPeerConnection();
                localStream.getTracks().forEach((track) => peerConnection.addTrack(track, localStream));
            })
            .catch((error) => {
                console.error('Chyba pri prístupe ku kamere alebo mikrofónu:', error);
                alert('Kamera alebo mikrofón neboli povolené.');
            });

        // Vytvorenie PeerConnection
        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(config);

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('signal', { candidate: event.candidate });
                }
            };

            peerConnection.ontrack = (event) => {
                remoteVideo.srcObject = event.streams[0];
                document.getElementById('remote-webcam-text').style.display = 'none';
            };

            // Vytvorenie a odoslanie ponuky
            peerConnection.onnegotiationneeded = async () => {
                try {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    socket.emit('signal', { offer: peerConnection.localDescription });
                } catch (err) {
                    console.error(err);
                }
            };
        }

        // Prijímanie signalizačných správ
        socket.on('signal', async (data) => {
            if (!peerConnection) createPeerConnection();

            if (data.offer) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                socket.emit('signal', { answer: peerConnection.localDescription });
            }

            if (data.answer) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
            }

            if (data.candidate) {
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                } catch (e) {
                    console.error('Chyba pri pridávaní ICE kandidáta', e);
                }
            }
        });

        // Ovládanie mikrofónu
        muteBtn.addEventListener('click', () => {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;

                    // Zmena ikony a stavu tlačidla
                    muteIcon.classList.toggle('fa-microphone', audioTrack.enabled);
                    muteIcon.classList.toggle('fa-microphone-slash', !audioTrack.enabled);
                    muteBtn.classList.toggle('inactive', !audioTrack.enabled);
                    muteBtn.classList.toggle('active', audioTrack.enabled);
                }
            }
        });

        // Ovládanie kamery
        cameraBtn.addEventListener('click', () => {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;

                    // Zmena ikony a stavu tlačidla
                    cameraIcon.classList.toggle('fa-video', videoTrack.enabled);
                    cameraIcon.classList.toggle('fa-video-slash', !videoTrack.enabled);
                    cameraBtn.classList.toggle('inactive', !videoTrack.enabled);
                    cameraBtn.classList.toggle('active', videoTrack.enabled);
                }
            }
        });

        // Ukončenie hovoru
        hangupBtn.addEventListener('click', () => {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach((track) => track.stop());
                localVideo.srcObject = null;
            }
            remoteVideo.srcObject = null;
            alert('Hovor bol ukončený.');
            socket.disconnect();
        });
    </script>
</body>
</html>
